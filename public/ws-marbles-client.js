function v(o){return o.type==="subscribe"||o.type==="unsubscribe"}function x(o){return !v(o)}var p=class{constructor(e,t){this.streams=new Map;this.isConnected=false;this.canvas=e;let i=e.getContext("2d");if(!i)throw new Error("Could not get 2D context from canvas");this.ctx=i,this.url=t.url,this.theme={...f,...t.theme},this.scrollSpeed=t.scrollSpeed??50,this.maxDuration=t.maxDuration??3e4,this.reconnectDelay=t.reconnectDelay??3e3,this.values=t.values,this.streamThemes=t.streamThemes,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas());}resizeCanvas(){let e=this.canvas.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height;}connect(){if(!(this.ws&&this.ws.readyState===WebSocket.OPEN))try{this.ws=new WebSocket(this.url),this.ws.onopen=()=>{console.log("WebSocket connected"),this.isConnected=!0,this.reconnectTimeoutId&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=void 0),this.requestStreamsList();},this.ws.onmessage=e=>{try{let t=JSON.parse(e.data);x(t)&&this.handleServerMessage(t);}catch(t){console.error("Error parsing WebSocket message:",t);}},this.ws.onerror=e=>{console.error("WebSocket error:",e);},this.ws.onclose=()=>{console.log("WebSocket disconnected"),this.isConnected=!1,this.scheduleReconnect();},this.animationFrameId||this.startAnimation();}catch(e){console.error("Failed to connect WebSocket:",e),this.scheduleReconnect();}}scheduleReconnect(){this.reconnectTimeoutId||(this.reconnectTimeoutId=setTimeout(()=>{this.reconnectTimeoutId=void 0,this.connect();},this.reconnectDelay));}requestStreamsList(){}handleServerMessage(e){switch(e.type){case "stream-info":if(!this.streams.has(e.streamId))this.streams.set(e.streamId,{streamId:e.streamId,name:e.name,events:[],startTime:Date.now(),active:true});else {let s=this.streams.get(e.streamId);s.name=e.name;}break;case "next":let t=this.streams.get(e.streamId);if(t){let s=e.timestamp-t.startTime;t.events.push({time:s,value:e.value,type:"next",timestamp:e.timestamp});}break;case "error":let i=this.streams.get(e.streamId);if(i){let s=e.timestamp-i.startTime;i.events.push({time:s,type:"error",timestamp:e.timestamp}),i.active=false;}break;case "complete":let r=this.streams.get(e.streamId);if(r){let s=e.timestamp-r.startTime;r.events.push({time:s,type:"complete",timestamp:e.timestamp}),r.active=false;}break;case "streams-list":e.streams.forEach(s=>{this.streams.has(s.streamId)||this.streams.set(s.streamId,{streamId:s.streamId,name:s.name,events:[],startTime:Date.now(),active:s.active});});break}}subscribe(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("WebSocket not connected");return}let t={type:"subscribe",streamId:e,timestamp:Date.now()};this.ws.send(JSON.stringify(t));}unsubscribe(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("WebSocket not connected");return}let t={type:"unsubscribe",streamId:e,timestamp:Date.now()};this.ws.send(JSON.stringify(t));let i=this.streams.get(e);i&&(i.active=false);}startAnimation(){let e=()=>{this.render(),this.animationFrameId=requestAnimationFrame(e);};e();}render(){let{width:e,height:t}=this.canvas;this.ctx.fillStyle=this.theme.backgroundColor,this.ctx.fillRect(0,0,e,t);let i=Date.now(),r=Array.from(this.streams.values()),s=t/Math.max(r.length,1);r.forEach((a,n)=>{let c=s*n+s/2;this.renderStream(a,c,i,e,s);}),this.drawConnectionStatus();}renderStream(e,t,i,r,s){let a=this.getStreamTheme(e.streamId),{padding:n,lineWidth:c,circleRadius:m,fontSize:l}=a,b=n+m,d=r-n-m;this.ctx.strokeStyle=a.lineColor,this.ctx.lineWidth=c,this.ctx.beginPath(),this.ctx.moveTo(b,t),this.ctx.lineTo(d,t),this.ctx.stroke(),this.ctx.fillStyle=a.textColor,this.ctx.font=`${l}px Arial, sans-serif`,this.ctx.textAlign="left",this.ctx.textBaseline="bottom",this.ctx.fillText(e.name,n,t-20);let S=i-e.startTime;e.events=e.events.filter(h=>S-h.time<this.maxDuration),e.events.forEach(h=>{let g=S-h.time,u=d-g*this.scrollSpeed/1e3;u>=b&&u<=d&&this.drawEvent(h,u,t,a);}),this.drawStreamStatus(e,r-n-20,t);}drawEvent(e,t,i,r){let{circleRadius:s,lineWidth:a,fontSize:n}=r;switch(e.type){case "next":let c=r.circleStrokeColor||r.lineColor,m=r.circleStrokeWidth||a;if(this.ctx.fillStyle=r.valueColor,this.ctx.strokeStyle=c,this.ctx.lineWidth=m,this.ctx.beginPath(),this.ctx.arc(t,i,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),e.value!==void 0){let l=this.values&&this.values[e.value]!==void 0?this.values[e.value]:e.value;this.ctx.fillStyle=r.textColor,this.ctx.font=`${n}px Arial, sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(String(l),t,i);}break;case "error":this.ctx.strokeStyle=r.errorColor,this.ctx.lineWidth=a*1.5,this.ctx.beginPath(),this.ctx.moveTo(t-s,i-s),this.ctx.lineTo(t+s,i+s),this.ctx.moveTo(t-s,i+s),this.ctx.lineTo(t+s,i-s),this.ctx.stroke();break;case "complete":this.ctx.strokeStyle=r.completeColor,this.ctx.lineWidth=a*2,this.ctx.beginPath(),this.ctx.moveTo(t,i-s*1.5),this.ctx.lineTo(t,i+s*1.5),this.ctx.stroke();break}}drawStreamStatus(e,t,i){this.ctx.fillStyle=e.active?"#4CAF50":"#757575",this.ctx.beginPath(),this.ctx.arc(t,i,4,0,2*Math.PI),this.ctx.fill();}drawConnectionStatus(){let{fontSize:e}=this.theme,t=this.isConnected?"Connected":"Disconnected",i=this.isConnected?"#4CAF50":"#f44336";this.ctx.fillStyle=i,this.ctx.font=`${e-2}px Arial, sans-serif`,this.ctx.textAlign="right",this.ctx.textBaseline="top",this.ctx.fillText(t,this.canvas.width-10,10);}getStreamTheme(e){return this.streamThemes&&this.streamThemes[e]?{...this.theme,...this.streamThemes[e]}:this.theme}disconnect(){this.reconnectTimeoutId&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=void 0),this.ws&&(this.ws.close(),this.ws=void 0),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=void 0),this.isConnected=false;}clear(){this.streams.clear();let{width:e,height:t}=this.canvas;this.ctx.fillStyle=this.theme.backgroundColor,this.ctx.fillRect(0,0,e,t);}updateOptions(e){e.theme&&(this.theme={...this.theme,...e.theme}),e.scrollSpeed!==void 0&&(this.scrollSpeed=e.scrollSpeed),e.maxDuration!==void 0&&(this.maxDuration=e.maxDuration),e.values!==void 0&&(this.values=e.values),e.streamThemes!==void 0&&(this.streamThemes=e.streamThemes);}};var f={backgroundColor:"#ffffff",lineColor:"#333333",valueColor:"#4CAF50",errorColor:"#f44336",completeColor:"#2196F3",textColor:"#000000",fontSize:14,lineWidth:2,circleRadius:8,padding:25,rowHeight:60,timeScale:3};export{p as WebSocketMarbleRenderer,f as defaultTheme,v as isClientMessage,x as isServerMessage};//# sourceMappingURL=client.mjs.map
//# sourceMappingURL=client.mjs.map